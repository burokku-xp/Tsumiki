# Design: Data Persistence

## Context

計測データを永続化するため、SQLiteデータベースを使用します。ローカルにデータを保存し、無期限に保持します。

## Goals / Non-Goals

### Goals
- 作業セッション、ファイル編集記録、日次統計を永続化
- 高速なデータアクセス
- マイグレーション機能によるスキーマ変更対応
- データの整合性保証

### Non-Goals
- リモートデータベースへの同期
- データの暗号化（ローカルファイルのため）
- 複数ユーザー間でのデータ共有

## Decisions

### Decision: better-sqlite3を使用
- **理由**: ネイティブバインディングによる高速パフォーマンス、同期APIでシンプル
- **代替案**: sql.js（WASM、非同期API）、node-sqlite3（非推奨）

### Decision: データベースファイルの保存場所はグローバルストレージ
- **理由**: ワークスペースに依存しない、ユーザー単位のデータ管理
- **代替案**: ワークスペース配下（`.vscode/tsumiki.db`）- ワークスペースごとにデータが分かれる

### Decision: テーブル設計
- **sessions**: 作業セッション（開始時刻、終了時刻、作業時間）
- **file_edits**: ファイル編集記録（ファイルパス、編集行数、言語、保存時刻）
- **daily_stats**: 日次統計（日付、作業時間、保存回数、ファイル数、変更行数、言語比率）

### Decision: マイグレーション機能を実装
- **理由**: 将来的なスキーマ変更に対応
- **代替案**: なし（必須）

## Risks / Trade-offs

- **リスク**: データベースファイルの破損
- **対策**: 定期的なバックアップ機能（将来実装）、トランザクション使用

- **リスク**: 大量データによるパフォーマンス低下
- **対策**: 適切なインデックス設定、古いデータのアーカイブ機能（将来実装）

- **リスク**: better-sqlite3のネイティブモジュールの互換性
- **対策**: ビルド済みバイナリの提供、フォールバック実装（将来検討）

## Migration Plan

初回実装のため、既存データのマイグレーションは不要です。

## Open Questions

- データベースファイルのバックアップ戦略（将来の機能として検討）
